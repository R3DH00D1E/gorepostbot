name: Deploy VK Telegram Repost Bot

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Build the bot
        run: |
          go build -o repostbot main.go

      - name: Generate .env file
        run: |
          echo "TG_TOKEN=${{ secrets.TG_TOKEN }}" > deploy/repostbot.env
          echo "VK_TOKEN=${{ secrets.VK_TOKEN }}" >> deploy/repostbot.env
          echo "TARGET_USER=${{ secrets.TARGET_USER }}" >> deploy/repostbot.env
          echo "CACHE_FILE=${{ secrets.CACHE_FILE }}" >> deploy/repostbot.env
          echo "POLL_INTERVAL=${{ secrets.POLL_INTERVAL }}" >> deploy/repostbot.env
          echo "CHAT_ID=${{ secrets.CHAT_ID }}" >> deploy/repostbot.env

      - name: Copy files to target directory
        run: |
          TARGET_DIR="${{ secrets.WORKDIR }}"
          if [ -z "$TARGET_DIR" ]; then
            echo "Error: WORKDIR is not set or empty."
            exit 1
          fi
          mkdir -p "$TARGET_DIR"
          cp repostbot "$TARGET_DIR/"
          cp deploy/repostbot.env "$TARGET_DIR/"

      - name: Create repostbot.service with WORKDIR substitution
        run: |
          sed "s|{{WORKDIR}}|${{ secrets.WORKDIR }}|g" deploy/repostbot.service.template > deploy/repostbot.service
          sudo cp deploy/repostbot.service /etc/systemd/system/repostbot.service

      - name: Copy repostbot.timer
        run: |
          sudo cp deploy/repostbot.timer /etc/systemd/system/repostbot.timer

      - name: Configure systemd
        run: |
          # Обновляем конфигурацию systemd
          sudo systemctl daemon-reload

          # Включаем и запускаем службы
          sudo systemctl enable repostbot.service
          sudo systemctl enable repostbot.timer
          sudo systemctl start repostbot.timer